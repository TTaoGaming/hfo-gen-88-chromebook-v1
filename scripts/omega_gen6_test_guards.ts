// Medallion: Bronze | Mutation: 0% | HIVE: V
import type { Page } from '@playwright/test';

export const GEN6_V16_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v16.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V16_1_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V16_1 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v16_1.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V17_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V17 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v17.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V17_1_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V17_1 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v17_1.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V17_2_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V17_2 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v17_2.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V17_3_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V17_3 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v17_3.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V17_4_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V17_4 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v17_4.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V17_5_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V17_5 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v17_5.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V18_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V18 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v18.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V19_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V19 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v19.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V20_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V20 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v20.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V21_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V21 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v21.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V22_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V22 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v22.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

// NOTE: v23 behavior is currently exercised against the v22 artifact until an omega_gen6_v23.html target
// exists. This keeps RED specs grounded (page loads) while still failing on missing v23 features.
export const GEN6_V23_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V23 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v23.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export const GEN6_V22_1_TEST_URL_LIGHT =
    process.env.HFO_GEN6_URL_V22_1 ||
    'http://localhost:8889/hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/omega_gen6_v22_1.html'
    + '?flag-disable-camera=true'
    + '&flag-engine-babylon=false'
    + '&flag-engine-canvas=false'
    + '&flag-ui-excalidraw=false'
    + '&flag-ui-lil-gui=false'
    + '&flag-p3-injector=false'
    + '&mode=dev';

export async function safeGoto(page: Page, url: string, attempts = 2): Promise<void> {
    let lastErr: unknown;
    for (let i = 0; i < attempts; i++) {
        try {
            await page.goto(url, { waitUntil: 'domcontentloaded' });
            return;
        } catch (e) {
            lastErr = e;
            try {
                await page.waitForTimeout(250);
            } catch {
                // ignore
            }
        }
    }
    throw lastErr;
}

export async function safeEvaluate<T, A>(page: Page, fn: (arg: A) => T | Promise<T>, arg: A, attempts = 2): Promise<T> {
    let lastErr: unknown;
    for (let i = 0; i < attempts; i++) {
        try {
            return await page.evaluate(fn as any, arg as any);
        } catch (e) {
            lastErr = e;
            try {
                await page.waitForTimeout(250);
            } catch {
                // ignore
            }
        }
    }
    throw lastErr;
}
