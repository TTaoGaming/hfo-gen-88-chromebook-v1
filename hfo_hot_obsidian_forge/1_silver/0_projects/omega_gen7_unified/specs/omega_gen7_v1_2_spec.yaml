# Medallion: Bronze | Mutation: 0% | HIVE: V
# Omega Mission Thread â€” Gen7 v1.2 Spec: Arbitrary Z-Layer Ordering + Kiosk Microkernel Defaults
# Timestamp (UTC): 2026-01-26
# Provenance: Restored as a draft to begin Gen7 v1.2 work; previously archived while Gen7 was capped to v1.1.
# Posture: Spec-first (Bronze). This file is a fail-closed contract of intent; implementation may be RED until wired.

meta:
  generation: 7
  version_major: 1
  version_minor: 2
  semantic_version: "1.2"
  status: "bronze-spec-draft"
  intent:
    - "Make z-layers arbitrarily adjustable at runtime (numeric zIndex), not just on/off toggles."
    - "Default Touch2D visualization OFF; preserve it as a toggleable layer."
    - "Default Excalidraw overlay opacity = 80% (0.8)."
    - "Enforce microkernel kiosk posture (GoldenLayout + lil-gui) for mosaic tile composition."

entrypoint:
  base:
    html: hfo_hot_obsidian_forge/1_silver/0_projects/omega_gen7_unified/app/omega_gen7_v1_1.html
  target:
    planned_html: hfo_hot_obsidian_forge/1_silver/0_projects/omega_gen7_unified/app/omega_gen7_v1_2.html
    note: "v1.2 may be implemented by patching v1.1 in-place or by creating a new entrypoint. This spec assumes a distinct v1.2 HTML for auditability."

scope:
  in_scope:
    - "Port-aligned layer visibility remains (P0 video, P1 touch2d tactical, P2 Babylon, P3 Excalidraw)."
    - "Add numeric zIndex per layer so stacking can be changed without code edits."
    - "Expose zIndex controls in P7 Navigator settings panel (GoldenLayout lil-gui component)."
    - "Persist most Port 7 Navigator settings to localStorage (settings persistence is ON by default)."
    - "Provide a clear reset-to-defaults control (must also clear persisted localStorage state)."
    - "Enforce zIndex range 00-99 inclusive (two-digit display + clamped numeric ordering)."
    - "Associate knuckle_triplane activation with COMMIT_THUMB_UP dwell/hysteresis (not COMMIT_POINTER_UP)."
    - "Expose PYREBLADE visualization when enabled and hand is READY; allow user adjustment based on palm knuckle span (lvl0 default)."
    - "Kiosk-first microkernel: essentialsMode is the default posture and should be enforced."
  out_of_scope:
    - "Refactoring core port logic (P0 sensing / P1 fusion / P2 FSM / P3 injection)."
    - "New UI frameworks; must keep GoldenLayout + lil-gui microkernel posture."

microkernel:
  shell:
    layout: "goldenlayout"
    settings_panel: "lil-gui"
    composition_model:
      - "Each port surface is a hexagonally composable exemplar tile in the mosaic layout."
      - "Z-layering is orthogonal to tile layout; a port can be visible yet behind another surface."

parameters:
  defaults:
    kiosk:
      essentialsMode_default: true
      enforced: true
      allow_override:
        url_query: false
        note: "If implementation retains ?kiosk=0 as an escape hatch, it must be treated as a dev-only override and clearly signaled."

    visuals:
      engine: "BABYLON"

    # Visibility toggles are retained (boolean), but order is controlled separately via zIndex.
    layers_visibility:
      p0Video: true
      p1Touch2D: false
      p2Babylon: true
      p3Excalidraw: true

    # NEW (v1.2): numeric zIndex per surface.
    # Contract: higher zIndex renders above lower.
    # Example profile: video=0, touch2d=10, excalidraw=30, babylon=90 (Babylon on top).
    layers_zindex:
      p0Video: 0
      p1Touch2D: 10
      p3Excalidraw: 30
      p2Babylon: 90

    excalidraw:
      opacity: 0.8
      enabled: true

    # Commit/gesture gating policy (Gen7 v1.2 extension)
    commit_gates:
      commit_pointer_up:
        activates:
          knuckle_triplane: false
          pyreblade: false
        note: "COMMIT_POINTER_UP must NOT activate or interact with knuckle_triplane/pyreblade in v1.2."
      commit_thumb_up:
        activates:
          knuckle_triplane: true
          pyreblade: true
        detection:
          confidence_gate: "high"
          dwell_charge_meter: true
          hysteresis: true
        note: "Thumb-up high-confidence dwell charge meter + hysteresis is the activator for knuckle_triplane/pyreblade."

    # Knuckle triplane visualization is driven by thumb-up activation.
    knuckle_triplane:
      enabled: true
      activation_source: "commit_thumb_up"
      interaction_when_hand_state:
        required: "READY"
        interaction_point: "fingertip"
      visualized_as:
        name: "PYREBLADE"
        note: "When PYREBLADE is on and hand is READY, fingertip interacts with knuckle_triplane visualized as a PYREBLADE."

    # PYREBLADE sizing is based on user palm/knuckle span, with power-of-eight levels.
    pyreblade:
      enabled_default: true
      sizing:
        basis: "palm_knuckle_span"
        level_pow8_default: 0  # lvl0 == 8^0 == 1x
        available_levels_pow8:
          - 0
          - 1  # lvl1 == 8^1 == 8x (already supported; should be swappable)
        lvl0_profile:
          forward_multiplier: 1.0   # blade out
          backward_multiplier: 0.5  # pommel/back
          asymmetry: true
        formula_note: "Effective span multiplier = 8^level_pow8. Apply forward/backward multipliers to the knuckle span basis."

    p7_settings_persistence:
      enabled: true
      backend: "localStorage"
      storage_key: "omega_gen7:p7_navigate"
      schema_version: "1.2"
      scope:
        include:
          - "p7_navigate.settings_panel_values"
          - "layers_visibility.*"
          - "layers_zindex.*"
          - "excalidraw.opacity"
        exclude:
          - "goldenlayout.layout_state"
        note: "Do NOT persist GoldenLayout layout state yet; reserve for a future version."
      reset_policy:
        clear_storage_on_reset: true
        restore_spec_defaults_on_reset: true

ports:
  p7_navigate:
    navigator_microkernel:
      description: "GoldenLayout + lil-gui tuning surface (Port 7)."
      required_controls:
        control_conventions:
          numeric_parameters:
            must_include:
              - "slider"
              - "numeric_input"
            note: "All numeric settings (e.g., zIndex, opacity) must expose both a slider and a numeric input."

        visibility_toggles:
          - "layers_visibility.p0Video"
          - "layers_visibility.p1Touch2D"
          - "layers_visibility.p2Babylon"
          - "layers_visibility.p3Excalidraw"

        zindex_controls:
          ui:
            widget: "lil-gui slider + numeric input"
            range:
              min: 0
              max: 99
              step: 1
            format: "two_digit_00_to_99"
            note: "Must allow simple number swaps to reorder layers; display as two digits (00-99), clamp to range, and disallow ties (all zIndex values must be unique)."
          fields:
            - "layers_zindex.p0Video"
            - "layers_zindex.p1Touch2D"
            - "layers_zindex.p3Excalidraw"
            - "layers_zindex.p2Babylon"

        persistence_controls:
          default_behavior:
            - "Load persisted settings from localStorage on startup (if present)."
            - "Persist settings to localStorage on every change (debounced is allowed)."
          required_actions:
            - "Reset to spec defaults"
          confirmation_prompt:
            required: true
            message: "Reset to defaults? This will permanently clear saved settings on this device."
          storage:
            backend: "localStorage"
            key: "omega_gen7:p7_navigate"
            note: "Reset must clear localStorage and restore spec defaults in the running session. Future: add export/import profiles; current: Pareto-optimal localStorage only."

        apply_policy:
          - "Changing any layer visibility or zIndex triggers immediate re-application (no reload)."
          - "ZIndex must apply even if visibility remains true (stacking is independent)."
          - "Persisted settings changes must be written to localStorage when persistence is enabled."
          - "Reset-to-defaults must update the running session immediately."
          - "Reject zIndex updates that would create duplicates; do not apply partial/invalid stacking."

        gesture_gate_controls:
          required:
            - "commit_gates.commit_pointer_up.activates.knuckle_triplane (must be false)"
            - "commit_gates.commit_pointer_up.activates.pyreblade (must be false)"
            - "commit_gates.commit_thumb_up.detection.confidence_gate"

acceptance:
  must:
    - "Gen7 v1.2 preserves Gen7 v1.1 runtime behavior when all v1.2 features are left at defaults (except explicit default changes listed in parameters.defaults)."
    - "All zIndex values must be unique; conflicting updates are rejected fail-closed."
    - "zIndex range is enforced (0-99 inclusive) and displayed as two digits (00-99)."
    - "Settings persistence is ON by default; reset clears localStorage and restores spec defaults."
    - "COMMIT_POINTER_UP never activates knuckle_triplane or pyreblade; COMMIT_THUMB_UP does (with dwell/hysteresis)."

  nice_to_have:
    - "Add an on-screen badge that indicates when settings are persisted vs defaults (dev-only)."
