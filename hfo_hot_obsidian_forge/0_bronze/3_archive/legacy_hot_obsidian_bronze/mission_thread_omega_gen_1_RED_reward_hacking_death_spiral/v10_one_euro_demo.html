<!-- Medallion: Bronze | Mutation: 0% | HIVE: LEGACY -->
<!--
// Medallion: Bronze | Mutation: 0% | HIVE: E
// ðŸ›¡ï¸ Omega Mission: V10 Physics Cursor (UI Shell Upgrade)
// Feature: Golden Layout Window Management + lil-gui Controls
// Technology: MediaPipe Hands + GoldenLayout + lil-gui + 1 Euro Filter
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFO Omega V10: 1â‚¬ Filter Demo</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/css/goldenlayout-base.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/css/themes/goldenlayout-dark-theme.css">
    <style>
        :root {
            --bg: #050510;
            --smooth-color: #00f2ff;
            --snappy-color: #ff0055;
            --panel-bg: rgba(0, 0, 0, 0.8);
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: var(--bg);
            font-family: 'JetBrains Mono', monospace;
            color: white;
        }

        #layout-container {
            width: 100%;
            height: 100%;
        }

        .component-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            position: relative;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.3;
            transform: scaleX(-1);
        }

        #output_canvas {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            transform: scaleX(-1);
        }

        .cursor {
            position: absolute;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
        }

        #cursor-smooth {
            background: var(--smooth-color);
            box-shadow: 0 0 30px var(--smooth-color);
        }

        #cursor-snappy {
            background: var(--snappy-color);
            box-shadow: 0 0 30px var(--snappy-color);
        }

        .cursor .label {
            position: absolute;
            top: -25px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            text-transform: uppercase;
            text-shadow: 0 0 5px #000;
        }

        /* Golden Layout Component Overrides */
        .lm_content {
            background: #000 !important;
        }

        .lil-gui {
            --width: 100%;
        }
    </style>
</head>

<body>
    <div id="layout-container"></div>

    <!-- Template for Video Component -->
    <template id="video-template">
        <div class="component-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="output_canvas"></canvas>
            <div id="cursor-smooth" class="cursor">
                <span class="label">Smooth Filter</span>
            </div>
            <div id="cursor-snappy" class="cursor">
                <span class="label">Snappy Filter</span>
            </div>
        </div>
    </template>

    <!-- Template for UI Component -->
    <template id="ui-template">
        <div class="component-container" style="background: #111; padding: 10px; overflow-y: auto;">
            <div id="gui-container"></div>
            <div id="status" style="font-size: 12px; color: #888; margin-top: 10px;">Initializing MediaPipe...</div>
        </div>
    </template>

    <script type="module">
        import { HandLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";
        import { GoldenLayout } from "https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/golden-layout.js";
        import GUI from "https://cdn.jsdelivr.net/npm/lil-gui@0.19.1/dist/lil-gui.esm.min.js";

        // --- 1 EURO FILTER IMPLEMENTATION ---
        class LowPassFilter {
            constructor(alpha) { this.alpha = alpha; this.lastValue = 0; this.hasLast = false; }
            filter(value, alpha) {
                if (alpha !== undefined) this.alpha = alpha;
                this.lastValue = this.hasLast ? this.alpha * value + (1 - this.alpha) * this.lastValue : value;
                this.hasLast = true;
                return this.lastValue;
            }
        }

        class OneEuroFilter {
            constructor(freq, mincutoff = 1.0, beta = 0.0) {
                this.freq = freq; this.mincutoff = mincutoff; this.beta = beta;
                this.x = new LowPassFilter(this._alpha(mincutoff));
                this.dx = new LowPassFilter(this._alpha(1.0));
                this.lastTime = null;
            }
            _alpha(cutoff) { return 1.0 / (1.0 + (1.0 / (2 * Math.PI * cutoff)) / (1.0 / this.freq)); }
            filter(value, timestamp) {
                if (this.lastTime) this.freq = 1.0 / ((timestamp - this.lastTime) / 1000);
                this.lastTime = timestamp;
                let dvalue = this.x.hasLast ? (value - this.x.lastValue) * this.freq : 0;
                let edvalue = this.dx.filter(dvalue, this._alpha(1.0));
                let cutoff = this.mincutoff + this.beta * Math.abs(edvalue);
                return this.x.filter(value, this._alpha(cutoff));
            }
        }

        // --- INIT FILTERS ---
        const filters = {
            smooth: { x: new OneEuroFilter(60, 0.5, 0.001), y: new OneEuroFilter(60, 0.5, 0.001) },
            snappy: { x: new OneEuroFilter(60, 1.0, 0.05), y: new OneEuroFilter(60, 1.0, 0.05) }
        };

        let statusEl, video, canvasElement, canvasCtx, cursorSmooth, cursorSnappy;
        let handLandmarker, drawingUtils;
        let skeletonAlpha = 0.5;

        const state = {
            numHands: 1,
            minHandDetectionConfidence: 0.5,
            minHandTrackingConfidence: 0.5,
            skeletonAlpha: 0.5,
            showSmooth: true,
            showSnappy: true
        };

        // --- GOLDEN LAYOUT SETUP ---
        const layoutContainer = document.getElementById('layout-container');
        const layout = new GoldenLayout(layoutContainer);

        let componentsReady = 0;
        const checkReady = () => {
            componentsReady++;
            if (componentsReady === 2) init(); // Start MediaPipe only when both parts are mounted
        };

        layout.registerComponentFactoryFunction('video-component', (container) => {
            const template = document.getElementById('video-template');
            container.element.appendChild(template.content.cloneNode(true));
            video = container.element.querySelector('#video');
            canvasElement = container.element.querySelector('#output_canvas');
            canvasCtx = canvasElement.getContext('2d');
            cursorSmooth = container.element.querySelector('#cursor-smooth');
            cursorSnappy = container.element.querySelector('#cursor-snappy');
            checkReady();
        });

        layout.registerComponentFactoryFunction('ui-component', (container) => {
            const template = document.getElementById('ui-template');
            container.element.appendChild(template.content.cloneNode(true));
            statusEl = container.element.querySelector('#status');
            const guiContainer = container.element.querySelector('#gui-container');

            const gui = new GUI({ container: guiContainer, title: 'HFO OMEGA V10 CONTROLS' });

            const mpFolder = gui.addFolder('MediaPipe Settings');
            mpFolder.add(state, 'numHands', 1, 4, 1);
            mpFolder.add(state, 'minHandDetectionConfidence', 0, 1, 0.1);
            mpFolder.add(state, 'minHandTrackingConfidence', 0, 1, 0.1);
            mpFolder.add(state, 'skeletonAlpha', 0, 1, 0.1).onChange(v => skeletonAlpha = v);
            mpFolder.add({ apply: () => reinit() }, 'apply').name('Apply & Restart');

            const filterFolder = gui.addFolder('Filter Toggles');
            filterFolder.add(state, 'showSmooth').name('Smooth Cursor').onChange(v => cursorSmooth.style.display = v ? 'flex' : 'none');
            filterFolder.add(state, 'showSnappy').name('Snappy Cursor').onChange(v => cursorSnappy.style.display = v ? 'flex' : 'none');

            gui.open();
            checkReady();
        });

        layout.loadLayout({
            root: {
                type: 'row',
                content: [
                    { type: 'component', componentType: 'video-component', title: 'Stream', isClosable: false },
                    { type: 'component', componentType: 'ui-component', title: 'Controls', width: 25, isClosable: false }
                ]
            }
        });

        // --- API EXPOSURE ---
        window.HFO_OMEGA_API = {
            getSettings: () => state,
            setSettings: (opts) => {
                Object.assign(state, opts);
                reinit();
            },
            getLandmarker: () => handLandmarker
        };

        async function init() {
            try {
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");

                skeletonAlpha = state.skeletonAlpha;

                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numHands: state.numHands,
                    minHandDetectionConfidence: state.minHandDetectionConfidence,
                    minHandTrackingConfidence: state.minHandTrackingConfidence
                });

                drawingUtils = new DrawingUtils(canvasCtx);

                statusEl.innerText = "Camera: Requesting...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;

                video.onloadeddata = () => {
                    canvasElement.width = video.videoWidth;
                    canvasElement.height = video.videoHeight;

                    statusEl.innerText = "System: Active (Tracking Index Tip)";
                    const predict = () => {
                        const results = handLandmarker.detectForVideo(video, performance.now());

                        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

                        if (results.landmarks?.length > 0) {
                            // Draw Bone Skeleton
                            canvasCtx.globalAlpha = skeletonAlpha;
                            for (const landmarks of results.landmarks) {
                                drawingUtils.drawConnectors(landmarks, HandLandmarker.HAND_CONNECTIONS, {
                                    color: "#00FF00",
                                    lineWidth: 5
                                });
                                drawingUtils.drawLandmarks(landmarks, { color: "#FF0000", lineWidth: 2 });
                            }
                            canvasCtx.globalAlpha = 1.0;

                            const tip = results.landmarks[0][8]; // Index Finger Tip
                            const t = performance.now();

                            // Map + Mirror (for natural feeling)
                            const rx = (1 - tip.x) * window.innerWidth;
                            const ry = tip.y * window.innerHeight;

                            // Update Smooth
                            const sx = filters.smooth.x.filter(rx, t);
                            const sy = filters.smooth.y.filter(ry, t);
                            cursorSmooth.style.left = `${sx}px`;
                            cursorSmooth.style.top = `${sy}px`;

                            // Update Snappy
                            const nx = filters.snappy.x.filter(rx, t);
                            const ny = filters.snappy.y.filter(ry, t);
                            cursorSnappy.style.left = `${nx}px`;
                            cursorSnappy.style.top = `${ny}px`;
                        }
                        requestAnimationFrame(predict);
                    };
                    predict();
                };
            } catch (err) {
                statusEl.innerText = `Error: ${err.message}`;
                statusEl.style.color = "#ff5555";
            }
        }

        async function reinit() {
            if (handLandmarker) handLandmarker.close();
            statusEl.innerText = "Re-initializing MediaPipe...";
            await init();
        }

        // Removed the loose init() call. It is now triggered by checkReady()
        // inside the Golden Layout component factory functions.
    </script>
</body>

</html>
