<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Omega Pointer Lab (Same-Origin)</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #050a05;
      --fg: #7cfc90;
      --muted: rgba(124, 252, 144, 0.6);
      --grid: rgba(124, 252, 144, 0.08);
      --warn: #ffcc00;
      --err: #ff4136;
    }
    html, body {
      margin: 0;
      height: 100%;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      overflow: hidden;
    }
    #wrap {
      position: relative;
      width: 100%;
      height: 100%;
    }
    canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      touch-action: none;
      background: radial-gradient(circle at 20% 20%, rgba(124,252,144,0.06), transparent 35%),
                  radial-gradient(circle at 80% 70%, rgba(0,255,255,0.04), transparent 40%),
                  #000;
    }
    #hud {
      position: absolute;
      left: 10px;
      top: 10px;
      z-index: 5;
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(124,252,144,0.25);
      border-radius: 10px;
      padding: 10px 10px;
      backdrop-filter: blur(6px);
      max-width: min(560px, calc(100vw - 20px));
    }
    #hud .title {
      font-weight: 700;
      letter-spacing: 0.02em;
      margin-bottom: 6px;
    }
    #hud .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }
    button {
      background: rgba(124,252,144,0.12);
      color: var(--fg);
      border: 1px solid rgba(124,252,144,0.25);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font: inherit;
    }
    button:hover { border-color: rgba(124,252,144,0.55); }
    button:active { transform: translateY(1px); }
    .kv {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 6px 10px;
      font-size: 12px;
    }
    .k { color: var(--muted); }
    .v { color: var(--fg); }
    #toast {
      position: absolute;
      right: 10px;
      bottom: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(124,252,144,0.2);
      background: rgba(0,0,0,0.55);
      color: var(--muted);
      max-width: min(520px, calc(100vw - 20px));
      font-size: 12px;
      white-space: pre-wrap;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="c"></canvas>

    <div id="hud" role="region" aria-label="Pointer Lab HUD">
      <div class="title">POINTER LAB — same-origin touch + mouse surface</div>
      <div class="kv">
        <div class="k">Pointers</div><div class="v" id="pointers">0</div>
        <div class="k">Last type</div><div class="v" id="ptype">—</div>
        <div class="k">Last id</div><div class="v" id="pid">—</div>
        <div class="k">Buttons</div><div class="v" id="pbuttons">—</div>
        <div class="k">Pressure</div><div class="v" id="ppressure">—</div>
      </div>
      <div class="row">
        <button id="btn-clear" type="button">Clear</button>
        <button id="btn-grid" type="button">Toggle grid</button>
        <button id="btn-capture" type="button">Capture on down</button>
      </div>
      <div class="row" style="font-size:12px; color: var(--muted)">Tip: use multi-touch + stylus if available. This app runs same-origin so P3 injection can target inside the iframe.</div>
    </div>

    <div id="toast">Ready.</div>
  </div>

  <script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d', { alpha: false });

    const elPointers = document.getElementById('pointers');
    const elType = document.getElementById('ptype');
    const elId = document.getElementById('pid');
    const elButtons = document.getElementById('pbuttons');
    const elPressure = document.getElementById('ppressure');
    const toast = document.getElementById('toast');

    const btnClear = document.getElementById('btn-clear');
    const btnGrid = document.getElementById('btn-grid');
    const btnCapture = document.getElementById('btn-capture');

    const pointers = new Map();
    let showGrid = true;
    let captureOnDown = true;

    function resize() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.max(1, Math.floor(rect.width * dpr));
      canvas.height = Math.max(1, Math.floor(rect.height * dpr));
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      draw();
    }

    function bg() {
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawGrid() {
      if (!showGrid) return;
      const w = canvas.clientWidth;
      const h = canvas.clientHeight;
      ctx.save();
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid') || 'rgba(124,252,144,0.08)';
      ctx.lineWidth = 1;
      const step = 50;
      for (let x = 0; x <= w; x += step) {
        ctx.beginPath();
        ctx.moveTo(x + 0.5, 0);
        ctx.lineTo(x + 0.5, h);
        ctx.stroke();
      }
      for (let y = 0; y <= h; y += step) {
        ctx.beginPath();
        ctx.moveTo(0, y + 0.5);
        ctx.lineTo(w, y + 0.5);
        ctx.stroke();
      }
      ctx.restore();
    }

    function drawPointer(p) {
      const { x, y, type, pressure, primary } = p;
      ctx.save();
      const r = 18 + Math.max(0, Math.min(1, pressure || 0)) * 22;
      ctx.globalAlpha = 0.85;
      ctx.fillStyle = type === 'pen' ? 'rgba(0,255,255,0.18)' : (type === 'touch' ? 'rgba(124,252,144,0.18)' : 'rgba(255,255,255,0.12)');
      ctx.strokeStyle = primary ? 'rgba(124,252,144,0.9)' : 'rgba(124,252,144,0.45)';
      ctx.lineWidth = primary ? 2 : 1;

      ctx.beginPath();
      ctx.arc(x, y, r, 0, Math.PI * 2);
      ctx.fill();
      ctx.stroke();

      ctx.globalAlpha = 0.9;
      ctx.fillStyle = 'rgba(124,252,144,0.85)';
      ctx.font = '12px ui-monospace, monospace';
      ctx.fillText(`${type}${primary ? ' *' : ''}`, x + r + 6, y - 4);
      ctx.fillText(`p=${(pressure ?? 0).toFixed(2)}`, x + r + 6, y + 12);
      ctx.restore();
    }

    function draw() {
      bg();
      drawGrid();
      // Draw active pointers
      for (const p of pointers.values()) drawPointer(p);
    }

    function toastMsg(msg) {
      toast.textContent = msg;
    }

    function updateHudFromEvent(e) {
      elPointers.textContent = String(pointers.size);
      elType.textContent = e.pointerType || '—';
      elId.textContent = String(e.pointerId ?? '—');
      elButtons.textContent = String(e.buttons ?? '—');
      const pr = (typeof e.pressure === 'number') ? e.pressure : 0;
      elPressure.textContent = String(pr.toFixed(2));
    }

    function toLocal(e) {
      const rect = canvas.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    function onDown(e) {
      canvas.focus?.();
      if (captureOnDown) {
        try { canvas.setPointerCapture(e.pointerId); } catch (_) {}
      }
      const { x, y } = toLocal(e);
      pointers.set(e.pointerId, {
        id: e.pointerId,
        type: e.pointerType,
        x,
        y,
        pressure: e.pressure,
        primary: !!e.isPrimary,
      });
      updateHudFromEvent(e);
      toastMsg(`pointerdown id=${e.pointerId} type=${e.pointerType} primary=${!!e.isPrimary}`);
      draw();
    }

    function onMove(e) {
      if (!pointers.has(e.pointerId)) return;
      const { x, y } = toLocal(e);
      const prev = pointers.get(e.pointerId);
      pointers.set(e.pointerId, {
        ...prev,
        x,
        y,
        pressure: e.pressure,
      });
      updateHudFromEvent(e);

      // ink trail
      ctx.save();
      ctx.strokeStyle = (e.pointerType === 'pen') ? 'rgba(0,255,255,0.35)' : 'rgba(124,252,144,0.35)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(prev.x, prev.y);
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.restore();

      draw();
    }

    function onUp(e) {
      if (pointers.has(e.pointerId)) pointers.delete(e.pointerId);
      updateHudFromEvent(e);
      toastMsg(`pointerup id=${e.pointerId} remaining=${pointers.size}`);
      draw();
    }

    function onCancel(e) {
      if (pointers.has(e.pointerId)) pointers.delete(e.pointerId);
      updateHudFromEvent(e);
      toastMsg(`pointercancel id=${e.pointerId} remaining=${pointers.size}`);
      draw();
    }

    btnClear.addEventListener('click', () => {
      pointers.clear();
      toastMsg('Cleared.');
      draw();
    });

    btnGrid.addEventListener('click', () => {
      showGrid = !showGrid;
      toastMsg(`Grid: ${showGrid ? 'ON' : 'OFF'}`);
      draw();
    });

    btnCapture.addEventListener('click', () => {
      captureOnDown = !captureOnDown;
      toastMsg(`Capture on down: ${captureOnDown ? 'ON' : 'OFF'}`);
    });

    canvas.addEventListener('pointerdown', onDown);
    canvas.addEventListener('pointermove', onMove);
    canvas.addEventListener('pointerup', onUp);
    canvas.addEventListener('pointercancel', onCancel);

    window.addEventListener('resize', resize);
    resize();
  </script>
</body>
</html>
