# Medallion: Bronze | Mutation: 0% | HIVE: V
# Omega Mission Thread â€” Gen7 v1.2 Spec: Arbitrary Z-Layer Ordering + Kiosk Microkernel Defaults
# Timestamp (UTC): 2026-01-26
# Provenance: Fork/evolve from omega_gen7_v1_1.html (Gen7 v1.1: port-aligned layers + safe inset + Excalidraw commit gating).
# Posture: Spec-first (Bronze). This file is a fail-closed contract of intent; implementation may be RED until wired.

meta:
  generation: 7
  version_major: 1
  version_minor: 2
  semantic_version: "1.2"
  status: "bronze-spec"
  intent:
    - "Make z-layers arbitrarily adjustable at runtime (numeric zIndex), not just on/off toggles."
    - "Default Touch2D visualization OFF; preserve it as a toggleable layer."
    - "Default Excalidraw overlay opacity = 80% (0.8)."
    - "Enforce microkernel kiosk posture (GoldenLayout + lil-gui) for mosaic tile composition."

entrypoint:
  base:
    html: hfo_hot_obsidian/bronze/1_projects/omega_gen7_v1_portable/app/omega_gen7_v1_1.html
  target:
    planned_html: hfo_hot_obsidian/bronze/1_projects/omega_gen7_v1_portable/app/omega_gen7_v1_2.html
    note: "v1.2 may be implemented by patching v1.1 in-place or by creating a new entrypoint. This spec assumes a distinct v1.2 HTML for auditability."

scope:
  in_scope:
    - "Port-aligned layer visibility remains (P0 video, P1 touch2d tactical, P2 Babylon, P3 Excalidraw)."
    - "Add numeric zIndex per layer so stacking can be changed without code edits."
    - "Expose zIndex controls in P7 Navigator settings panel (GoldenLayout lil-gui component)."
    - "Persist most Port 7 Navigator settings to localStorage (settings persistence is ON by default)."
    - "Provide a clear reset-to-defaults control (must also clear persisted localStorage state)."
    - "Enforce zIndex range 00-99 inclusive (two-digit display + clamped numeric ordering)."
    - "Associate knuckle_triplane activation with COMMIT_THUMB_UP dwell/hysteresis (not COMMIT_POINTER_UP)."
    - "Expose PYREBLADE visualization when enabled and hand is READY; allow user adjustment based on palm knuckle span (lvl0 default)."
    - "Kiosk-first microkernel: essentialsMode is the default posture and should be enforced."
  out_of_scope:
    - "Refactoring core port logic (P0 sensing / P1 fusion / P2 FSM / P3 injection)."
    - "New UI frameworks; must keep GoldenLayout + lil-gui microkernel posture."

microkernel:
  shell:
    layout: "goldenlayout"
    settings_panel: "lil-gui"
    composition_model:
      - "Each port surface is a hexagonally composable exemplar tile in the mosaic layout."
      - "Z-layering is orthogonal to tile layout; a port can be visible yet behind another surface."

parameters:
  defaults:
    kiosk:
      essentialsMode_default: true
      enforced: true
      allow_override:
        url_query: false
        note: "If implementation retains ?kiosk=0 as an escape hatch, it must be treated as a dev-only override and clearly signaled."

    visuals:
      engine: "BABYLON"

    # Visibility toggles are retained (boolean), but order is controlled separately via zIndex.
    layers_visibility:
      p0Video: true
      p1Touch2D: false
      p2Babylon: true
      p3Excalidraw: true

    # NEW (v1.2): numeric zIndex per surface.
    # Contract: higher zIndex renders above lower.
    # Example profile: video=0, touch2d=10, excalidraw=30, babylon=90 (Babylon on top).
    layers_zindex:
      p0Video: 0
      p1Touch2D: 10
      p3Excalidraw: 30
      p2Babylon: 90

    excalidraw:
      opacity: 0.8
      enabled: true

    # Commit/gesture gating policy (Gen7 v1.2 extension)
    commit_gates:
      commit_pointer_up:
        activates:
          knuckle_triplane: false
          pyreblade: false
        note: "COMMIT_POINTER_UP must NOT activate or interact with knuckle_triplane/pyreblade in v1.2."
      commit_thumb_up:
        activates:
          knuckle_triplane: true
          pyreblade: true
        detection:
          confidence_gate: "high"
          dwell_charge_meter: true
          hysteresis: true
          leaky_bucket_lock:
            fill_seconds: 1.0
            drain_seconds: 1.0
            note: "Leaky bucket: 1s to FILL (lock), 1s to DRAIN (brief tracking loss or movement drains)."
          requires_ready_state: true
        note: "Same FSM as READY, but uses BOTH READY + high confidence THUMB UP gesture. Thumb-up high-confidence dwell charge meter + hysteresis is the activator for knuckle_triplane/pyreblade."

      commit_thumbs_down:
        drains:
          pyreblade: true
        requires_ready_state: true
        note: "READY + COMMIT_THUMBS_DOWN drains the PYREBLADE (charge meter)."

    # Knuckle triplane visualization is driven by thumb-up activation.
    knuckle_triplane:
      enabled: true
      activation_source: "commit_thumb_up"
      interaction_when_hand_state:
        required: "READY"
        interaction_point: "fingertip"
      visualized_as:
        name: "PYREBLADE"
        note: "When PYREBLADE is on and hand is READY, fingertip interacts with knuckle_triplane visualized as a PYREBLADE."

    # PYREBLADE sizing is based on user palm/knuckle span, with power-of-eight levels.
    pyreblade:
      enabled_default: true
      meaning: "PYREBLADE == CHARGE meter visualization"
      state_model:
        per_hand: true
        hand_key: "hand_id"
        lock_persistence:
          persists_across_ready_idle: true
          note: "Once locked it should stay regardless of IDLE/READY; it locks onto the knuckle of that hand."
        drain_policy:
          event: "commit_thumbs_down"
          requires_ready_state: true
          note: "Locked only READY + COMMIT_THUMBS_DOWN drains the PYREBLADE."
      tracking_loss_policy:
        mode: "COAST"
        forbid_screen_center_teleport: true
        note: "On tracking loss it should COAST; it shouldn't appear in the middle of the screen."
      sizing:
        basis: "palm_knuckle_span"
        units: "meters"
        world_space: true
        perspective_effect: "distance_scaling (hand closer -> bigger; hand farther -> smaller)"
        level_pow8_default: 0  # lvl0 == 8^0 == 1x
        available_levels_pow8:
          - 0
          - 1  # lvl1 == 8^1 == 8x (already supported; should be swappable)
        lvl0_profile:
          forward_multiplier: 1.0   # blade out
          backward_multiplier: 0.5  # pommel/back
          asymmetry: true
        formula_note: "Effective span multiplier = 8^level_pow8. Apply forward/backward multipliers to the knuckle span basis."

    p7_settings_persistence:
      enabled: true
      backend: "localStorage"
      storage_key: "omega_gen7:p7_navigate"
      schema_version: "1.2"
      scope:
        include:
          - "p7_navigate.settings_panel_values"
          - "layers_visibility.*"
          - "layers_zindex.*"
          - "excalidraw.opacity"
        exclude:
          - "goldenlayout.layout_state"
        note: "Do NOT persist GoldenLayout layout state yet; reserve for a future version."
      reset_policy:
        clear_storage_on_reset: true
        restore_spec_defaults_on_reset: true

ports:
  p7_navigate:
    navigator_microkernel:
      description: "GoldenLayout + lil-gui tuning surface (Port 7)."
      required_controls:
        control_conventions:
          numeric_parameters:
            must_include:
              - "slider"
              - "numeric_input"
            note: "All numeric settings (e.g., zIndex, opacity) must expose both a slider and a numeric input."

        visibility_toggles:
          - "layers_visibility.p0Video"
          - "layers_visibility.p1Touch2D"
          - "layers_visibility.p2Babylon"
          - "layers_visibility.p3Excalidraw"

        zindex_controls:
          ui:
            widget: "lil-gui slider + numeric input"
            range:
              min: 0
              max: 99
              step: 1
            format: "two_digit_00_to_99"
            note: "Must allow simple number swaps to reorder layers; display as two digits (00-99), clamp to range, and disallow ties among visible layers (visible-layer zIndex values must be unique)."
          fields:
            - "layers_zindex.p0Video"
            - "layers_zindex.p1Touch2D"
            - "layers_zindex.p3Excalidraw"
            - "layers_zindex.p2Babylon"

        persistence_controls:
          default_behavior:
            - "Load persisted settings from localStorage on startup (if present)."
            - "Persist settings to localStorage on every change (debounced is allowed)."
          required_actions:
            - "Reset to spec defaults"
          confirmation_prompt:
            required: true
            message: "Reset to defaults? This will permanently clear saved settings on this device."
          storage:
            backend: "localStorage"
            key: "omega_gen7:p7_navigate"
            note: "Reset must clear localStorage and restore spec defaults in the running session. Future: add export/import profiles; current: Pareto-optimal localStorage only."

        apply_policy:
          - "Changing any layer visibility or zIndex triggers immediate re-application (no reload)."
          - "ZIndex must apply even if visibility remains true (stacking is independent)."
          - "Persisted settings changes must be written to localStorage when persistence is enabled."
          - "Reset-to-defaults must update the running session immediately."
          - "Reject zIndex updates that would create duplicates among visible layers; do not apply partial/invalid stacking."

        gesture_gate_controls:
          required:
            - "commit_gates.commit_pointer_up.activates.knuckle_triplane (must be false)"
            - "commit_gates.commit_pointer_up.activates.pyreblade (must be false)"
            - "commit_gates.commit_thumb_up.detection.confidence_gate"
            - "commit_gates.commit_thumb_up.detection.dwell_charge_meter"
            - "commit_gates.commit_thumb_up.detection.hysteresis"
          note: "Expose as read-only or guarded controls; default posture is thumb-up activation only."

        pyreblade_controls:
          enable_toggle: "pyreblade.enabled_default"
          level_pow8:
            widget: "lil-gui slider + numeric input"
            allowed_values: [0, 1]
            note: "lvl0=1x (8^0); lvl1=8x (8^1). Future: additional levels as powers of eight."
          lvl0_profile:
            forward_multiplier:
              widget: "lil-gui slider + numeric input"
              range: { min: 0.25, max: 2.0, step: 0.05 }
            backward_multiplier:
              widget: "lil-gui slider + numeric input"
              range: { min: 0.0, max: 1.0, step: 0.05 }
          note: "PYREBLADE sizing must be adjustable by the user based on palm knuckle span; default asym profile is 1.0 forward / 0.5 backward."

implementation_notes:
  zlayer_application:
    dom_targets:
      p0_video: "<video> element: use style.zIndex + opacity/visibility (not display:none)."
      p1_touch2d: "tactical overlay canvas/div: use style.zIndex + display toggle."
      p2_babylon: "babylon canvas layer(s): use style.zIndex + display toggle when engine==BABYLON."
      p3_excalidraw: "excalidraw overlay container: use style.zIndex + display toggle; apply excalidraw.opacity default." 
    collision_policy:
      - "zIndex ties are NOT allowed: all visible layers must have unique zIndex values."
      - "If a tie is requested via UI or persisted state, the system must fail-closed (reject update, revert to last known-good zIndex map, and surface a user-visible warning)."

  commit_and_pyreblade:
    operator_verbatim_requirements: |
      dwell needs ot be leaky bucket to lock, time let's make it 1 second to FILL and 1 second to DRAIN. so brief tracking loss or movement just drains. this is the same FSM as my READY state but instead of palm cone orientation to camera, we are using both READY + high confidence THUMB UP GESTURE. once the PYREBLADE is locked it should stay regardless of IDLE/READY it should just lock onto the knuckle of that hand (and we should have multiple for hands so each handid should have their own independant PYREBLADE.) ontracking loss it should COAST, it shouldn't appear in the middle of the screen like it is now. 2, zindex uniqueness let's enfocement only on visible layers so infinite inactive layers only 00-99 active layers. 3, it should be in meters but as a ratio of knucklespan, so as user moves hand closer it appears bigger as hand moves father it appears smaller. 4, PYREBLADE is locked only READY + COMMIT_THUMBS_DOWN drains the PYREBLADE. the PYREBLADE is literally the visualization of the charge meter it's a PYREBLADE - CHARGE meter. make sure to document my exact words into the yaml
    invariants:
      - "COMMIT_POINTER_UP must not activate knuckle_triplane or pyreblade."
      - "Thumb-up activation must require high confidence + dwell charge meter + hysteresis."
      - "If hand is not READY, fingertip must not interact with knuckle_triplane/pyreblade." 
      - "Once PYREBLADE is locked, it persists across IDLE/READY until drained via READY + COMMIT_THUMBS_DOWN."
      - "Per-hand independence: each hand_id maintains an independent PYREBLADE lock/charge state."
      - "Tracking loss must COAST; never teleport PYREBLADE to screen center."
    sizing_basis:
      - "Compute palm_knuckle_span from hand landmarks (implementation-defined; must be consistent)."
      - "Use lvl0 (8^0) by default; lvl1 (8^1) must remain easy to swap to."

validation:
  posture: "Bronze acceptance checks (manual) + RED-first gates (TDD + BDD required before implementation)."
  acceptance_criteria:
    - "Default Touch2D visual layer is OFF (hidden) on first load."
    - "Default Excalidraw opacity is 0.8 (80%)."
    - "P7 settings can change zIndex for each layer live and the stacking updates immediately."
    - "Babylon can be placed on top by setting its zIndex highest (e.g., 90)."
    - "Kiosk essentials mode is enforced by default; microkernel settings remain usable in kiosk posture."
    - "zIndex controls clamp to the inclusive range 00-99 and display as two digits."
    - "zIndex values are unique among visible layers; ties among visible layers are rejected."
    - "Most P7 settings persist via localStorage across reload by default."
    - "Reset-to-defaults prompts for confirmation, then restores spec defaults and clears persisted localStorage state."
    - "COMMIT_POINTER_UP does not activate knuckle_triplane or pyreblade."
    - "Thumb-up (high confidence + dwell + hysteresis) activates knuckle_triplane/pyreblade."
    - "When PYREBLADE is enabled and hand is READY, fingertip interaction targets the knuckle_triplane visualized as PYREBLADE."
    - "PYREBLADE lvl0 defaults to forward=1.0x knuckle span and backward=0.5x knuckle span; user can switch to lvl1=8x."

  red_first_requirements:
    tdd: "Required (write failing tests before wiring implementation)."
    bdd: "Required (write scenarios before wiring implementation)."
    bdd_scenarios:
      - "Given default load, when page loads first time, then Touch2D is hidden and Excalidraw opacity is 0.8."
      - "Given zIndex changes in P7, when user reloads, then persisted zIndex values are restored from localStorage."
      - "Given persisted settings exist, when user clicks Reset to spec defaults, then localStorage is cleared and defaults are restored live."
      - "Given COMMIT_POINTER_UP occurs, when pointer-up is detected, then knuckle_triplane/pyreblade are not activated."
      - "Given thumb-up high confidence dwell completes, when hysteresis confirms, then knuckle_triplane/pyreblade become active."
      - "Given pyreblade level is set to lvl0, when palm_knuckle_span changes, then pyreblade scales with forward=1.0 and backward=0.5 multipliers." 
      - "Given thumb-up leaky bucket lock, when thumb-up confidence is high and READY holds for 1s, then PYREBLADE locks." 
      - "Given thumb-up leaky bucket lock, when tracking briefly drops or READY breaks, then charge drains over 1s and does not lock." 
      - "Given PYREBLADE is locked for a hand_id, when READY becomes IDLE, then PYREBLADE stays locked and remains attached to that hand's knuckle." 
      - "Given PYREBLADE is locked, when tracking is lost, then PYREBLADE COASTS from last known pose and never teleports to screen center." 
      - "Given PYREBLADE is locked and READY, when COMMIT_THUMBS_DOWN occurs, then PYREBLADE drains/unlocks (charge meter resets)." 

sources:
  - hfo_hot_obsidian/bronze/1_projects/omega_gen7_v1_portable/app/omega_gen7_v1_1.html
