# Medallion: Bronze | Mutation: 0% | HIVE: V
# Omega Mission Thread — Gen7 v2 (Hydra Bud)
# Focus: Refactor Gen7 portability + Port7 tuning surfaces without changing default behavior.
# Provenance: forked from Gen7 v1 (itself migrated from Gen6 v23.10 baseline).

meta:
  generation: 7
  version: 2
  status: "bronze-refactor"
  intent:
    - "Preserve the Gen6 v23.10 offline-ready posture (OpenFeature + local libs) inside a portable project directory."
    - "Formalize fork-and-evolve (hydra budding): new HTML/spec artifacts are additive and keep lineage."
    - "Keep default runtime behavior identical to Gen7 v1 unless explicitly enabled by flags."
    - "Make Port7 tuning surfaces (lil-gui) the canonical knobs; enable external control via same-origin messages only."

entrypoint:
  base:
    html: hfo_hot_obsidian/bronze/1_projects/omega_gen7_v1_portable/app/omega_gen7_v1.html
  target:
    html: hfo_hot_obsidian/bronze/1_projects/omega_gen7_v1_portable/app/omega_gen7_v2.html

scope:
  in_scope:
    - "Multi-hand: support N cursors/hands (at least 2) in the tripplane→key pipeline."
    - "Tripplane: use knuckle tripplane distance + velocity to derive direction and robust begin/end edges."
    - "Predictive: use predictiveLookaheadMs (TTC/TOI window) to optionally schedule early keydown before crossing."
    - "Port7: expose tuning controls in Navigator microkernel UI (lil-gui) and apply live without reload."
    - "Governance: refuse cross-origin tuning messages; accept only a small, schema-like allowlist of parameter updates."
  out_of_scope:
    - "Gen7 multi-finger (index/middle/ring/pinky) chord mapping (tracked as Gen7 v3)."
    - "Contract hardening across Zod ports (tracked as Silver promotion work)."

ports:
  p1_data_fabric:
    cursors:
      description: "Fused cursor streams; each cursor maps to a hand instance for tripplane evaluation."
      required_fields:
        - handIndex
        - pointerId
        - fsmState
        - readinessScore
        - uiNormX
        - uiNormY
        - landmarks

  p2_shape:
    knuckle_tripplane:
      description: "Per-cursor knuckle tripplane and predictive TTC estimation (TOI/TTC)."
      per_cursor_inputs:
        - landmarks[0]  # wrist
        - landmarks[5]  # index knuckle
        - landmarks[17] # pinky knuckle
        - landmarks[8]  # index fingertip
      outputs:
        tripwire_cross_event:
          type: "p2/tripwire_cross"
          payload_fields:
            - sensorId: "knuckle"
            - sensor.phase: "begin|end"
            - direction: "down|up"
            - speedUiNormPerS
            - sensor.distance.orientedDistanceVelUiNormPerS
        tripplane_lookahead_event:
          type: "p2/tripplane_lookahead"
          payload_fields:
            - sensorId: "knuckle"
            - ttcMs
            - lookaheadWindowMs
            - orientedDistanceVelUiNormPerS

  p3_deliver:
    tripplane_key_injector:
      description: "Consumes p2 tripplane events and injects keyboard edges (keydown/keyup) gated by COMMIT and deadman; supports predictive early keydown scheduling."
      key_mapping_policy:
        - "Key mapping is configurable per-handIndex (and later per handKey once stable identity lands)."
        - "Default mapping may be identical for all hands (Space), but must be overrideable."
      velocity_policy:
        - "Press/release may optionally require minimum velocity thresholds to reduce jitter."

  p7_navigate:
    navigator_microkernel:
      description: "Hot-swap tuning surface (lil-gui) for Gen7 v2 tripplane→key behavior."
      required_controls:
        - "predictiveLookaheadMs / lookaheadWindowMs (ms)"
        - "predictive scheduling bias (ms)"
        - "enable/disable predictive scheduling"
        - "per-hand key code mapping (handIndex→KeyboardEvent.code)"
        - "optional min speed thresholds for begin/end edges"

lineage:
  artifact_kind: "spec"
  artifact_id: "omega_gen7_v2_spec"
  parents:
    - artifact_id: "omega_gen7_v1_spec"
      path: "hfo_hot_obsidian/bronze/1_projects/omega_gen7_v1_portable/specs/omega_gen7_v1_spec.yaml"
  notes:
    - "Non-destructive evolution: v1 remains the baseline; v2 is a refactor bud."

migration_notes:
  carry_forward:
    - "Offline-ready OpenFeature + local module map is already present in Gen6 v23.10; Gen7 v1 must preserve that posture."
    - "Hand identity stability (coast + snaplock + anchoring) remains a known pain point; v24 notes remain relevant as guidance for future Gen7 multi-hand identity hardening."

validation:
  posture: "Bronze smoke checks only."
  acceptance_criteria:
    - "Gen7 v2 loads and behaves identically to Gen7 v1 by default (no flags changed)."
    - "Port7 Navigator can change predictiveLookaheadMs (lookaheadWindowMs) live and affect scheduling behavior."
    - "Port7 Navigator can change injected key code (at least handIndex 0/1) live without reload."
    - "Tripplane begin emits keydown and end emits keyup (COMMIT-gated + deadman fail-closed)."

sources:
  - hfo_hot_obsidian/bronze/1_projects/omega_gen7_v1_portable/app/omega_gen7_v1.html
  - hfo_hot_obsidian/bronze/1_projects/omega_gen7_v1_portable/app/omega_gen7_v2.html
  - hfo_hot_obsidian/bronze/3_resources/para/omega_gen6_current/specs/omega_gen6_v24_spec.yaml
