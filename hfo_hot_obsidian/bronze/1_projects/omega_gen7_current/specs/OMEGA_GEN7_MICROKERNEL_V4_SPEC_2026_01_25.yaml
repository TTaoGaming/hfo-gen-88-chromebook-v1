# Medallion: Bronze | Mutation: 0% | HIVE: V
# Omega Mission Thread — Gen7 Microkernel Boundaries Spec (v4)
# Date: 2026-01-25
# Purpose: Make microkernel boundaries explicit so agents stop drifting.
#          Kernel API + plugin interfaces are the only allowed cross-module coupling.

spec:
  id: omega_gen7_microkernel_v4
  version: "2026-01-25"
  status: draft
  medallion: bronze
  mutation_score_target: 0
  hive: V

scope:
  goals:
    - "Establish a canonical Omega Gen7 project root (this folder) to prevent drift."
    - "Make microkernel boundaries explicit: kernel owns orchestration; plugins own domain logic."
    - "Define kernel API surface + plugin interface contracts + versioning/compat policy (fork/evolve)."
    - "Anchor the Gen7 interaction target: single-hand triplane with 4-finger keying and a new COMMIT gesture."
  non_goals:
    - "This spec does not preserve omega_gen7_v1_portable as a parallel active project; it is deprecated after assimilation."
    - "This spec does not finalize the exact COMMIT gesture; it defines the interface + experimental policy."

canonical_project:
  root: hfo_hot_obsidian/bronze/1_projects/omega_gen7_current
  subprojects:
    - id: omega_gen7_v1_portable_deprecated
      path: hfo_hot_obsidian/bronze/1_projects/omega_gen7_v1_portable
      trust_level: "deprecated"
      note: "ASSIMILATED: legacy content has been migrated under omega_gen7_current (e.g., specs/assimilated_v1_portable and app/omega_gen7_v7_1.html). Keep only as a legacy stub if referenced by historical receipts." 

artifact_layout:
  portability_rule: "All artifacts under omega_gen7_current must be runnable via static server without absolute paths or network fetches."
  directories:
    app: "Portable HTML entrypoints + local libs/adapters"
    specs: "Versioned intent specs (v1/v2/v3 + microkernel v4)"
    references: "Vendored historical references (e.g., Gen6 v23.10)"
    tests:
      fast: "Playwright regressions (bounded; low-RAM safe runner compatible)"
      slow: "Golden masters + optional MP4 clips (CI/nightly)"
      manifests:
        - tests/golden_masters/manifest.json
        - tests/clips/manifest.json

microkernel:
  principle: "Plugins never call each other directly. All cross-plugin communication routes via the kernel API (bus + registry + contracts)."
  boundaries:
    kernel_owns:
      - "Plugin lifecycle: discover/load/init/start/stop/unload"
      - "Capability registry + dependency resolution"
      - "Event bus (publish/subscribe) with typed topics"
      - "State store namespaces (config, tuning, session, readiness)"
      - "Contracts validation gate for all cross-boundary payloads"
      - "Fail-closed policy: missing capability/invalid payload => disable plugin or abort boot"
      - "Telemetry + proof emission (append-only events; trace correlation)"
      - "UI host shell + layout mounting points"
    plugin_owns:
      - "Domain logic (gesture parsing, tripplane computation, key injection policy)"
      - "Visualization implementations (GoldenLayout panels, overlays)"
      - "User tuning surfaces (Port7 lil-gui panels)"
      - "Test harnesses (CI gates)"
    forbidden:
      - "Plugin importing another plugin’s code directly (no hidden coupling)"
      - "UI components reaching into physics/gesture internals except through kernel APIs"
      - "Cross-port payloads bypassing contracts validation"

kernel_api:
  versioning:
    kernel_semver: "MAJOR.MINOR.PATCH"
    plugin_api_version: "v1"

  core_objects:
    Kernel:
      responsibilities:
        - "Plugin registry"
        - "Bus"
        - "State"
        - "UI host"
        - "Contracts gate"

  lifecycle_hooks:
    - name: onRegister
      called_when: "Plugin is loaded; plugin declares capabilities + commands + UI contributions"
    - name: onStart
      called_when: "Kernel enters running state"
    - name: onStop
      called_when: "Kernel is stopping (hot reload or shutdown)"

  bus:
    rules:
      - "Topics are namespaced: omega.gen7.*"
      - "All events include trace_id/span_id and a monotonic timestamp when available"
      - "Payloads validate against contracts before delivery"
    required_topics:
      - omega.gen7.readiness
      - omega.gen7.gesture.raw
      - omega.gen7.commit.state
      - omega.gen7.tripplane.edge
      - omega.gen7.key.inject
      - omega.gen7.tuning.update

  state:
    namespaces:
      kernel_config: "immutable boot config + feature flags"
      tuning: "user-tunable params (Port7 UI)"
      session: "ephemeral runtime state"
      readiness: "readiness meter values + gating state"
    rules:
      - "Plugins can only write to their own subtree (e.g., tuning.plugins.<id>.*)"
      - "Kernel owns global gating state (e.g., readiness, deadman)"

  ui_host:
    mount_points:
      - id: main_layout
        purpose: "GoldenLayout root"
      - id: tuning_panel
        purpose: "Port7 lil-gui root"
      - id: diagnostics
        purpose: "CI/test + telemetry panels"

plugin_interfaces:
  manifest:
    required_fields:
      - plugin_id
      - plugin_version
      - plugin_type
      - entrypoint
      - kernel_compat
      - plugin_api_version
      - capabilities
    compatibility:
      kernel_compat: "semver range, e.g. ^0.4.0"
      plugin_api_version: "v1"

  types:
    - plugin_type: logic
      required_capabilities:
        - omega.gen7.logic
      required_hooks:
        - onRegister
        - onStart
      contracts:
        - "Consumes omega.gen7.gesture.raw"
        - "Emits omega.gen7.tripplane.edge"

    - plugin_type: goldenlayout_visualization
      required_capabilities:
        - omega.gen7.viz.goldenlayout
      required_hooks:
        - onRegister
      contracts:
        - "Subscribes to readiness/commit/tripplane/key topics"

    - plugin_type: port7_lilgui_tunables
      required_capabilities:
        - omega.gen7.ui.tuning
      required_hooks:
        - onRegister
      contracts:
        - "Writes omega.gen7.tuning.update (validated)"

    - plugin_type: ci_test
      required_capabilities:
        - omega.gen7.ci
      required_hooks:
        - onRegister
      contracts:
        - "Exports a deterministic test surface (e.g., window.hfoEval)"

versioning_policy:
  goals:
    - "Make fork/evolve non-destructive and auditable."
    - "Prevent agent drift by pinning canon: omega_gen7_current + this spec."
  semver_rules:
    kernel:
      major_breaking:
        - "Breaking changes to kernel API or plugin API version"
      minor:
        - "New optional APIs, topics, mount points"
      patch:
        - "Bugfixes, perf, docs"
    plugins:
      rule: "Plugins use semver and must declare kernel_compat."
  deprecation:
    policy:
      - "Breaking removals require (a) a major bump, (b) a migration note, (c) N-1 compatibility window when feasible."

fork_and_evolve:
  rule: "Prefer lineage over mutation. New experiments are forks, not silent edits."
  required_lineage_fields:
    - artifact_id
    - parents
    - intent
    - compat
    - promotion_target
  promotion:
    bronze_to_silver:
      requires:
        - "Red→Green tests in CI plugin"
        - "Contracts validation present for all cross-boundary payloads"
        - "Proof bundle references (logs/screenshots/trace)"

omega_gen7_interaction_target:
  primary_goal: "Single-hand triplane + 4-finger keying (multi-fingertip)."
  readiness_meter:
    importance: "Very high (anti-mitus: too much information)."
    rule: "COMMIT gesture is only honored when readiness is above threshold and deadman is satisfied."

  commit_gesture_variants:
    existing_in_ready_state:
      - commit_pointer_up
      - commit_thumbs_up
      - commit_thumbs_down
    proposed_for_triplane:
      - id: commit_open_palm_dwell
        algorithm: "leaky_bucket_dwell_hysteresis"
        dwell_ms_min: 1000
        note: "Pointer-up should stop being the commit gesture for the triplane mode; open palm dwell may be safer."

  feature_flags:
    rule: "Each app can choose its COMMIT variant without changing core logic."
    examples:
      - app: triplane_4finger
        commit_gesture: commit_open_palm_dwell
      - app: legacy_pointer
        commit_gesture: commit_pointer_up

red_tdd_plan:
  principle: "Write RED tests first (fail-closed), then implement minimal kernel+plugins to go GREEN."
  initial_red_tests:
    - id: gen7_commit_gesture_open_palm_dwell
      type: playwright
      asserts:
        - "Pointer-up does NOT trigger COMMIT in triplane_4finger mode"
        - "Open palm held >= dwell_ms_min triggers COMMIT"
        - "COMMIT only possible when readiness >= threshold"
    - id: gen7_four_finger_keying
      type: playwright
      asserts:
        - "After COMMIT, 4 fingertips map to 4 distinct key codes"
        - "Release edges are deterministic and fail-closed on confidence drop"
    - id: gen7_mode_feature_flag_matrix
      type: unit_or_contract
      asserts:
        - "App X uses commit variant Y (feature-flagged)"

sources:
  - hfo_hot_obsidian/bronze/1_projects/omega_gen7_v1_portable/specs/omega_gen7_v1_spec.yaml
  - hfo_hot_obsidian/bronze/1_projects/omega_gen5_current/GEN5_V10_HEX_MODULAR_MONOLITH_SPEC_2026_01_20.yaml
  - contracts/

verbatim_user_request: |-
  There has been some errors and you crashed. I just finished running get operations with a different agent, so please look at the tail of the memory. In the MCP and help me understand our current progress, I. Really want to work on. Omega generation 7 writing the different specs because. The AI agents keep forgetting what I'm really building and one of the main things I really wanna do right now is to get single hand tripling 4 fingers. So what I want to do is I want to do a specific. Commit gesture. And then have it activate. With different fingers, I think I need a different commit gesture than pointer up. In fact, I think pointer up. Should stop being the commit gesture for the trip lane. I think maybe something like. Leaky bucket dwell hysteresis. With open palm as the commit gesture. But it needs to be a little longer, so I'm thinking even like 1 2nd or something because once the user is in that position. Then they can just stay there and then just use the the 4 keys. I'm not sure yet. There's lots of little pieces and. What we can do is we can just have different modes and feature flags where we got OK. This is, you know, X app uses Y commit gesture. So right now we have a few commit variants. We'll need to extend those. We all we should already have commit pointer up, commit thumbs up, commit thumbs down, all while in a ready state. The readiness meter is really important because that's antimitus. Too much information. Please save to memory MCP, save my exact wording down and note it in the YAML.

  I think I want the spec to live inside the like a new Canonical Omega Gen 7 project route. In fact, I think we need to move. A bunch of the stuff out from the Gen 7 V 1 Portable. My main goal right now is that they are starting to become drift. I know Gen 7V1 is OK, but Gen 7V2V3V4 those are all. I think there might be hallucinations in there, so I'm not so sure about those. My main goal right now is to get. Multi fingertip so walk me through what we need. Help me write the spec. Help me write red TDD first. You know, what I need you to do right now actually, is to just understand my system. Update the memory, MCP as necessary, make sure that we bring everything and set our pointer system set up correctly so that we're all targeting the right generation 7.
