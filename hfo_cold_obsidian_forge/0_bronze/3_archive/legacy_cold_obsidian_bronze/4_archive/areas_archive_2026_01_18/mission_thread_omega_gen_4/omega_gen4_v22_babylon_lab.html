<!-- Medallion: Bronze | Mutation: 0% | HIVE: E -->
<!-- OMEGA GEN 4 V22 - BABYLON.JS FIRE CURSOR SHOWCASE -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFO OMEGA GEN 4 | V22 BABYLON FIRE</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #050505;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #ff4444;
        }
        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
            display: block;
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border: 2px solid #ff4444;
            border-radius: 8px;
            pointer-events: auto;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.2);
            min-width: 200px;
        }
        .variant-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: #111;
            color: #eee;
            border: 1px solid #333;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .variant-btn:hover {
            background: #222;
            border-color: #ff4444;
            transform: translateX(5px);
        }
        .variant-btn.active {
            background: #ff4444;
            color: #000;
            font-weight: 900;
            border-color: #fff;
        }
        .label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            color: #ff4444;
            display: block;
            border-bottom: 1px solid #ff4444;
            padding-bottom: 5px;
        }
        #status-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            font-family: monospace;
            font-size: 10px;
            color: #ff4444;
            border: 1px solid #444;
        }
    </style>
</head>
<body>
    <div id="ui">
        <span class="label">HFO OMEGA V22 // BABYLON SUBSTRATE</span>
        <button class="variant-btn active" onclick="switchVariant(0)">0x01 PHOENIX CORE</button>
        <button class="variant-btn" onclick="switchVariant(1)">0x02 PLASMA BLUE</button>
        <button class="variant-btn" onclick="switchVariant(2)">0x03 ASH & CINDER</button>
        <button class="variant-btn" onclick="switchVariant(3)">0x04 JET THRUST</button>
    </div>

    <div id="status-panel">
        PORT 2: SHAPER // BABYLON 7.0<br>
        STATE: IDLE_LAB<br>
        PROVENANCE: BRONZE_V22
    </div>

    <canvas id="renderCanvas"></canvas>

    <script>
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        let currentVariant = 0;
        let activeSystems = [];
        let emitterRoot;

        const createScene = function () {
            const scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color4(0.01, 0.01, 0.01, 1);

            // Orthographic Camera for Cursor Parity
            const camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(0, 0, -10), scene);
            camera.setTarget(BABYLON.Vector3.Zero());

            const light = new BABYLON.PointLight("light1", new BABYLON.Vector3(0, 0, -5), scene);
            light.intensity = 0.8;
            light.diffuse = new BABYLON.Color3(1, 0.3, 0.1);

            // Emitter root that follows mouse
            emitterRoot = BABYLON.MeshBuilder.CreateSphere("emitter", {diameter: 0.05}, scene);
            emitterRoot.isVisible = false;
            light.parent = emitterRoot; // Light follows emitter

            // Initial variant
            setupVariant(0, scene);

            // Mouse interaction
            window.addEventListener("pointermove", (evt) => {
                if (!scene.activeCamera) return;
                
                // Ensure matrices are ready to avoid copyToArray error
                const viewMatrix = scene.getViewMatrix();
                const projectionMatrix = scene.getProjectionMatrix();
                if (!viewMatrix || !projectionMatrix) return;

                const width = engine.getRenderWidth();
                const height = engine.getRenderHeight();

                // Precise Unproject mapping to Z=0 plane
                const vector = new BABYLON.Vector3(evt.clientX, evt.clientY, 0);
                const worldCoordNear = BABYLON.Vector3.Unproject(
                    vector,
                    width,
                    height,
                    BABYLON.Matrix.Identity(),
                    scene.getViewMatrix(),
                    scene.getProjectionMatrix()
                );
                
                const vectorFar = new BABYLON.Vector3(evt.clientX, evt.clientY, 1);
                const worldCoordFar = BABYLON.Vector3.Unproject(
                    vectorFar,
                    width,
                    height,
                    BABYLON.Matrix.Identity(),
                    scene.getViewMatrix(),
                    scene.getProjectionMatrix()
                );
                
                const direction = worldCoordFar.subtract(worldCoordNear).normalize();
                
                // Solve for Z=0
                // worldCoordNear.z + t * direction.z = 0
                // t = -worldCoordNear.z / direction.z
                if (Math.abs(direction.z) > 0.0001) {
                    const distance = -worldCoordNear.z / direction.z;
                    const intersectionPoint = worldCoordNear.add(direction.scale(distance));
                    emitterRoot.position.copyFrom(intersectionPoint);
                }
            });

            return scene;
        };

        function clearActiveSystems() {
            activeSystems.forEach(sys => {
                sys.stop();
                sys.dispose();
            });
            activeSystems = [];
        }

        function setupVariant(index, scene) {
            clearActiveSystems();
            currentVariant = index;

            // Texture Fallback logic: Use verified BabylonJS Playground assets
            const defaultTexture = "https://playground.babylonjs.com/textures/flare.png";
            const smokeTexture = "https://playground.babylonjs.com/textures/cloud.png";

            // Refresh Buttons
            const buttons = document.querySelectorAll('.variant-btn');
            buttons.forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });

            switch(index) {
                case 0: // Phoenix Core
                    const fire = new BABYLON.ParticleSystem("fire", 2000, scene);
                    fire.particleTexture = new BABYLON.Texture(defaultTexture, scene);
                    fire.emitter = emitterRoot;
                    fire.minEmitBox = new BABYLON.Vector3(-0.05, 0, -0.05);
                    fire.maxEmitBox = new BABYLON.Vector3(0.05, 0, 0.05);
                    fire.color1 = new BABYLON.Color4(1, 0.6, 0.2, 1.0);
                    fire.color2 = new BABYLON.Color4(1, 0.2, 0, 1.0);
                    fire.colorDead = new BABYLON.Color4(0.2, 0, 0, 0.0);
                    fire.minSize = 0.1; fire.maxSize = 0.6;
                    fire.minLifeTime = 0.2; fire.maxLifeTime = 0.5;
                    fire.emitRate = 600;
                    fire.blendMode = BABYLON.ParticleSystem.BLENDMODE_ONEONE;
                    fire.gravity = new BABYLON.Vector3(0, 15, 0);
                    fire.start();
                    activeSystems.push(fire);
                    break;

                case 1: // Plasma Blue
                    const plasma = new BABYLON.ParticleSystem("plasma", 1000, scene);
                    plasma.particleTexture = new BABYLON.Texture(defaultTexture, scene);
                    plasma.emitter = emitterRoot;
                    plasma.color1 = new BABYLON.Color4(0.3, 0.7, 1.0, 1.0);
                    plasma.color2 = new BABYLON.Color4(0.1, 0.2, 0.9, 1.0);
                    plasma.colorDead = new BABYLON.Color4(0, 0, 0.5, 0.0);
                    plasma.minSize = 0.3; plasma.maxSize = 0.8;
                    plasma.emitRate = 400;
                    plasma.blendMode = BABYLON.ParticleSystem.BLENDMODE_ONEONE;
                    plasma.updateSpeed = 0.02;
                    plasma.addVelocityGradient(0, 2);
                    plasma.addVelocityGradient(1, 0.5);
                    plasma.start();
                    activeSystems.push(plasma);
                    break;

                case 2: // Ash & Cinder
                    const smoke = new BABYLON.ParticleSystem("smoke", 200, scene);
                    smoke.particleTexture = new BABYLON.Texture(smokeTexture, scene);
                    smoke.emitter = emitterRoot;
                    smoke.color1 = new BABYLON.Color4(0.3, 0.3, 0.3, 0.4);
                    smoke.color2 = new BABYLON.Color4(0.1, 0.1, 0.1, 0.1);
                    smoke.minSize = 1.0; smoke.maxSize = 2.5;
                    smoke.emitRate = 40;
                    smoke.gravity = new BABYLON.Vector3(0, 2, 0);
                    smoke.start();
                    activeSystems.push(smoke);

                    const sparks = new BABYLON.ParticleSystem("sparks", 150, scene);
                    sparks.particleTexture = new BABYLON.Texture(defaultTexture, scene);
                    sparks.emitter = emitterRoot;
                    sparks.color1 = new BABYLON.Color4(1, 0.9, 0.5, 1.0);
                    sparks.minSize = 0.02; sparks.maxSize = 0.1;
                    sparks.minEmitPower = 5; sparks.maxEmitPower = 10;
                    sparks.emitRate = 120;
                    sparks.gravity = new BABYLON.Vector3(0, -5, 0);
                    sparks.start();
                    activeSystems.push(sparks);
                    break;

                case 3: // Jet Thrust
                    const jet = new BABYLON.ParticleSystem("jet", 1500, scene);
                    jet.particleTexture = new BABYLON.Texture(defaultTexture, scene);
                    jet.emitter = emitterRoot;
                    jet.createConeEmitter(0.1, 0.2);
                    jet.color1 = new BABYLON.Color4(0.9, 1.0, 1.0, 1.0);
                    jet.color2 = new BABYLON.Color4(1.0, 0.4, 0.0, 0.8);
                    jet.minSize = 0.05; jet.maxSize = 0.25;
                    jet.minEmitPower = 12; jet.maxEmitPower = 25;
                    jet.emitRate = 1500;
                    jet.minLifeTime = 0.05; jet.maxLifeTime = 0.15;
                    jet.start();
                    activeSystems.push(jet);
                    break;
            }
        }

        const scene = createScene();

        engine.runRenderLoop(function () {
            scene.render();
        });

        window.addEventListener("resize", function () {
            engine.resize();
        });

        window.switchVariant = function(index) {
            setupVariant(index, scene);
        };
    </script>
</body>
</html>
