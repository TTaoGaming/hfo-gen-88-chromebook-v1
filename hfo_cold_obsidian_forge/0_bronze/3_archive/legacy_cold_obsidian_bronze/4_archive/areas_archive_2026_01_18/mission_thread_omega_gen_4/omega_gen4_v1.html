<!-- Medallion: Bronze | Mutation: 0% | HIVE: I -->
<!-- OMEGA GEN 4 V1.0 - PHOENIX PRODUCTION MONOLITH -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFO | OMEGA GEN 4 V1.0 - HERO SUBSTRATE</title>

    <!-- CSS Dependencies -->
    <link type="text/css" rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/css/goldenlayout-base.css" />
    <link type="text/css" rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/css/themes/goldenlayout-dark-theme.css" />

    <style>
        :root {
            /* Material Design 3 (M3) Dark Theme Palette */
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary: #CCC2DC;
            --md-sys-color-on-secondary: #332D41;
            --md-sys-color-surface: #1C1B1F;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;

            --hfo-red: #FF4136;
            --hfo-black: #000000;
            --m3-radius: 12px;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: var(--hfo-black);
            color: var(--md-sys-color-on-surface);
            font-family: 'Roboto', 'IBM Plex Mono', system-ui, sans-serif;
            letter-spacing: 0.25px;
        }

        #layout-container {
            width: 100%;
            height: calc(100% - 28px);
        }

        #status-bar {
            height: 28px;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.8px;
            border-top: 1px solid var(--md-sys-color-outline);
            text-transform: uppercase;
            z-index: 100;
        }

        .component-container {
            padding: 0;
            height: 100%;
            overflow: hidden;
            box-sizing: border-box;
            background: var(--hfo-black);
            position: relative;
        }

        /* Hero Feed Styles (1:1 Coordinate Parity) */
        .hero-view-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #video-feed {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* Ensures aspect ratio preservation */
            transform: scaleX(-1);
            filter: grayscale(0.5) contrast(1.1) brightness(0.8);
        }

        #overlay-canvas {
            position: absolute;
            /* Matches mirrored video exact bounding box */
            /* Calculated in JS */
            transform: scaleX(-1);
            pointer-events: none;
            z-index: 5;
        }

        .hero-placeholder {
            position: absolute;
            z-index: 10;
            color: var(--md-sys-color-primary);
            font-size: 1.5rem;
            font-weight: 300;
            text-align: center;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: var(--m3-radius);
            border: 1px solid var(--md-sys-color-outline);
        }

        .hfo-header {
            border-left: 4px solid var(--hfo-red);
            padding: 4px 12px;
            margin: 16px;
            background: var(--md-sys-color-surface-variant);
            border-radius: 0 4px 4px 0;
        }

        .hfo-header h3 {
            margin: 0;
            font-size: 0.9rem;
            color: var(--md-sys-color-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        /* M3 Style Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--md-sys-color-surface);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--md-sys-color-outline);
            border-radius: 10px;
            border: 2px solid var(--md-sys-color-surface);
        }

        /* lil-gui styling override (M3ish) */
        .lil-gui {
            --background-color: var(--md-sys-color-surface);
            --text-color: var(--md-sys-color-on-surface);
            --title-background-color: var(--md-sys-color-primary-container);
            --title-text-color: var(--md-sys-color-on-primary-container);
            --widget-color: var(--md-sys-color-surface-variant);
            --focus-color: var(--md-sys-color-primary);
            --font-family: 'Roboto Mono', monospace;
            --font-size: 11px;
            width: 100% !important;
            max-width: none !important;
        }

        #settings-mount {
            overflow-y: auto !important;
            height: 100%;
        }

        /* Action Buttons */
        .p0-controls {
            position: absolute;
            bottom: 32px;
            z-index: 20;
            display: flex;
            gap: 12px;
        }

        .hfo-btn {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            /* M3 Pill */
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hfo-btn:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
            transform: translateY(-1px);
            background: var(--md-sys-color-on-primary-container);
            color: var(--md-sys-color-primary-container);
        }
    </style>
</head>

<body>
    <div id="layout-container"></div>
    <div id="status-bar">
        <span>[HFO OMEGA GEN 4]</span>
        <span style="margin-left: auto;">P0_SENSE: IDLE | P1_FUSE: STANDBY | P2_SHAPE: READY | MEDALLION: BRONZE</span>
    </div>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "golden-layout": "https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/+esm",
            "lil-gui": "https://cdn.jsdelivr.net/npm/lil-gui@0.19.1/+esm",
            "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js"
        }
    }
    </script>

    <script type="module">
        import { GoldenLayout } from 'golden-layout';
        import GUI from 'lil-gui';
        import { GestureRecognizer, FilesetResolver, DrawingUtils } from '@mediapipe/tasks-vision';

        // --- PRODUCTION STATE ---
        const systemState = {
            parameters: {
                minConfidence: 0.5,
                numHands: 2,
                minTrackingConfidence: 0.5,
                minHandPresenceConfidence: 0.5,
                delegate: 'GPU',
                showSkeleton: true,
                p0Active: false,
                mirror: true,
                drawConnections: true,
                drawLandmarks: true,
                connectorColor: '#D0BCFF',
                landmarkColor: '#FF4136'
            },
            telemetry: {
                latency: 0,
                jitter: 0,
                load: 0,
                fps: 0,
                handsDetected: 0,
                resolution: '0x0'
            },
            p0: {
                recognizer: null,
                drawingUtils: null,
                video: null,
                canvas: null,
                ctx: null,
                lastVideoTime: -1,
                videoBounds: null
            },
            hands: [] // Required for Port 3 injection and E2E tests
        };

        // Expose global for automated testing (P5 Hardgate Compliance)
        window.hfoState = systemState;
        window.initHFO = async () => {
            const btn = document.getElementById('btn-start-p0');
            if (btn) btn.click();
        };
        window.initPhysics = window.initHFO; // Legacy support
        window.port3Inject = (hand) => {
            logMission(`P3_INJECT: State=${hand.fsm.state} Event=${hand.fsm.pointerEvent}`);
        };

        // --- P0: SENSE (MediaPipe Integration) ---
        async function initP0() {
            logMission("P0: Initializing MediaPipe Manifold...");
            try {
                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm"
                );
                systemState.p0.recognizer = await GestureRecognizer.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task",
                        delegate: systemState.parameters.delegate
                    },
                    runningMode: "VIDEO",
                    numHands: systemState.parameters.numHands,
                    minHandDetectionConfidence: systemState.parameters.minConfidence,
                    minHandPresenceConfidence: systemState.parameters.minHandPresenceConfidence,
                    minTrackingConfidence: systemState.parameters.minTrackingConfidence
                });
                systemState.p0.drawingUtils = new DrawingUtils(systemState.p0.ctx);
                logMission("âœ… P0: MediaPipe Shard Online");
            } catch (e) {
                logMission(`âš ï¸ P0: GPU/Primary Initialization Failed. Falling back to CPU...`, '#FF8C00');
                try {
                    const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm");
                    systemState.p0.recognizer = await GestureRecognizer.createFromOptions(vision, {
                        baseOptions: {
                            modelAssetPath: "https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task",
                            delegate: "CPU"
                        },
                        runningMode: "VIDEO",
                        numHands: systemState.parameters.numHands,
                        minHandDetectionConfidence: systemState.parameters.minConfidence,
                        minHandPresenceConfidence: systemState.parameters.minHandPresenceConfidence,
                        minTrackingConfidence: systemState.parameters.minTrackingConfidence
                    });
                    systemState.p0.drawingUtils = new DrawingUtils(systemState.p0.ctx);
                    logMission("âœ… P0: MediaPipe Shard Online (CPU-SAFE)");
                } catch (err2) {
                    logMission(`âŒ P0: Total Initialization Failure - ${err2.message}`, '#FF4136');
                }
            }
        }

        async function startCamera() {
            if (!systemState.p0.video) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                systemState.p0.video.srcObject = stream;
                systemState.p0.video.addEventListener('loadeddata', () => {
                    systemState.parameters.p0Active = true;
                    systemState.telemetry.resolution = `${systemState.p0.video.videoWidth}x${systemState.p0.video.videoHeight}`;
                    resizeCanvas();
                    requestAnimationFrame(predictLoop);
                });
            } catch (e) {
                logMission(`âŒ Camera Access Denied: ${e.message}`, '#FF4136');
            }
        }

        function predictLoop() {
            if (!systemState.p0.recognizer || !systemState.parameters.p0Active) return;

            try {
                const nowInMs = performance.now();
                if (systemState.p0.video.readyState >= 2 && systemState.p0.video.currentTime !== systemState.p0.lastVideoTime) {
                    systemState.p0.lastVideoTime = systemState.p0.video.currentTime;

                    const results = systemState.p0.recognizer.recognizeForVideo(systemState.p0.video, nowInMs);

                    // Sync to global state for E2E and Port 3 injection
                    if (results && results.landmarks) {
                        systemState.hands = results.landmarks.map((m, i) => ({
                            landmarks: m,
                            gestures: results.gestures ? results.gestures[i] : [],
                            active: true,
                            fsm: { state: 'POINTER_READY' }
                        }));

                        drawResults(results);
                        updateTelemetry(results);
                    }
                }
            } catch (err) {
                console.error("Predict loop error:", err);
            }

            requestAnimationFrame(predictLoop);
        }

        /**
         * ðŸŽ¯ COORDINATE PARITY FIX
         * Ensures drawing matches the visible video pixels regardless of layout scaling
         */
        function drawResults(results) {
            const { ctx, canvas, video, drawingUtils } = systemState.p0;
            if (!ctx || !video.videoWidth || !drawingUtils) return;

            // Clear previous frame
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (results.landmarks && systemState.parameters.showSkeleton) {
                for (const landmarks of results.landmarks) {
                    // Manual Scale Calculation (if DrawingUtils scaling fails parity)
                    // Results are normalized 0-1.
                    if (systemState.parameters.drawConnections) {
                        drawingUtils.drawConnectors(landmarks, GestureRecognizer.HAND_CONNECTIONS, {
                            color: systemState.parameters.connectorColor,
                            lineWidth: 3
                        });
                    }
                    if (systemState.parameters.drawLandmarks) {
                        drawingUtils.drawLandmarks(landmarks, {
                            color: systemState.parameters.landmarkColor,
                            lineWidth: 1,
                            radius: 3
                        });
                    }
                }
            }
        }

        function resizeCanvas() {
            const { video, canvas } = systemState.p0;
            if (!video || !canvas) return;

            // 1. Get the actual rendered dimensions of the video element (affected by object-fit: contain)
            const videoRect = video.getBoundingClientRect();
            const containerRect = video.parentElement.getBoundingClientRect();

            // 2. Calculate coordinates derived from object-fit: contain
            const videoRatio = video.videoWidth / video.videoHeight;
            const containerRatio = containerRect.width / containerRect.height;

            let drawWidth, drawHeight;
            if (containerRatio > videoRatio) {
                drawHeight = containerRect.height;
                drawWidth = drawHeight * videoRatio;
            } else {
                drawWidth = containerRect.width;
                drawHeight = drawWidth / videoRatio;
            }

            // 3. Sync canvas size to internal video resolution for best fidelity
            // But we scale it with CSS to match the video feed exactly
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            canvas.style.width = `${drawWidth}px`;
            canvas.style.height = `${drawHeight}px`;

            systemState.p0.videoBounds = { width: drawWidth, height: drawHeight };
        }

        function updateTelemetry(results) {
            systemState.telemetry.handsDetected = results.landmarks ? results.landmarks.length : 0;
            const now = performance.now();
            if (systemState.telemetry.lastTime) {
                const delta = now - systemState.telemetry.lastTime;
                systemState.telemetry.fps = Math.round(1000 / delta);
            }
            systemState.telemetry.lastTime = now;
        }

        function logMission(msg, color = '#00ff41') {
            const logs = document.getElementById('mission-logs-content');
            if (!logs) return;
            const entry = document.createElement('div');
            entry.style.color = color;
            entry.style.marginBottom = '4px';
            const time = new Date().toLocaleTimeString('en-GB', { hour12: false });
            entry.innerText = `[${time}] ${msg}`;
            logs.prepend(entry);
        }

        // --- COMPONENTS ---
        const layoutConfig = {
            root: {
                type: 'row',
                content: [
                    {
                        type: 'component',
                        title: 'Hero Viewport',
                        componentType: 'hero',
                        width: 70
                    },
                    {
                        type: 'column',
                        width: 30,
                        content: [
                            {
                                type: 'component',
                                title: 'Command Manifold',
                                componentType: 'settings',
                                height: 50
                            },
                            {
                                type: 'component',
                                title: 'Live Telemetry',
                                componentType: 'telemetry',
                                height: 25
                            },
                            {
                                type: 'component',
                                title: 'System Logs',
                                componentType: 'logs',
                                height: 25
                            }
                        ]
                    }
                ]
            }
        };

        const container = document.getElementById('layout-container');
        const layout = new GoldenLayout(container);

        // --- Component: Hero ---
        layout.registerComponentFactoryFunction('hero', (container) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'component-container';

            wrapper.innerHTML = `
                <div class="hero-view-container">
                    <div class="hero-placeholder">P0 SENSE OFFLINE<span>INITIALIZE MEDIA PIPE TO START</span></div>
                    <video id="video-feed" autoplay playsinline></video>
                    <canvas id="overlay-canvas"></canvas>
                    <div class="p0-controls">
                        <button id="btn-start-p0" class="hfo-btn">Initialize Phoenix</button>
                    </div>
                </div>
            `;
            container.getElement().appendChild(wrapper);

            systemState.p0.video = wrapper.querySelector('#video-feed');
            systemState.p0.canvas = wrapper.querySelector('#overlay-canvas');
            systemState.p0.ctx = systemState.p0.canvas.getContext('2d');

            const btn = wrapper.querySelector('#btn-start-p0');
            btn.addEventListener('click', async () => {
                btn.innerText = "Igniting...";
                btn.disabled = true;
                await initP0();
                await startCamera();
                btn.style.display = 'none';
                wrapper.querySelector('.hero-placeholder').style.display = 'none';
            });

            window.addEventListener('resize', resizeCanvas);
            setTimeout(resizeCanvas, 1000);
        });

        // --- Component: Settings (M3 Expanded) ---
        layout.registerComponentFactoryFunction('settings', (container) => {
            const div = document.createElement('div');
            div.className = 'component-container';
            div.id = 'settings-mount';
            container.getElement().appendChild(div);

            const gui = new GUI({ container: div, title: 'âš™ï¸ SYSTEM CONFIG', touchStyles: true, autoPlace: false });

            const fP0 = gui.addFolder('P0: Sensing (Neural)');
            fP0.add(systemState.parameters, 'minConfidence', 0.1, 1.0).name('Detection Confidence').onChange(updateP0);
            fP0.add(systemState.parameters, 'minTrackingConfidence', 0.1, 1.0).name('Tracking Confidence').onChange(updateP0);
            fP0.add(systemState.parameters, 'minHandPresenceConfidence', 0.1, 1.0).name('Presence Confidence').onChange(updateP0);
            fP0.add(systemState.parameters, 'numHands', 1, 4, 1).name('Max Hands').onChange(updateP0);
            fP0.add(systemState.parameters, 'delegate', ['CPU', 'GPU']).name('Compute Unit').onChange(updateP0);

            const fVisuals = gui.addFolder('P2: Visual Strategy');
            fVisuals.add(systemState.parameters, 'showSkeleton').name('Enable Skeleton');
            fVisuals.add(systemState.parameters, 'drawConnections').name('Draw Connectors');
            fVisuals.add(systemState.parameters, 'drawLandmarks').name('Draw Shards');
            fVisuals.addColor(systemState.parameters, 'connectorColor').name('Connector Col');
            fVisuals.addColor(systemState.parameters, 'landmarkColor').name('Shard Col');

            function updateP0() {
                if (systemState.p0.recognizer) {
                    systemState.p0.recognizer.setOptions({
                        numHands: systemState.parameters.numHands,
                        minHandDetectionConfidence: systemState.parameters.minConfidence,
                        minHandPresenceConfidence: systemState.parameters.minHandPresenceConfidence,
                        minTrackingConfidence: systemState.parameters.minTrackingConfidence
                    });
                }
            }
        });

        // --- Component: Telemetry ---
        layout.registerComponentFactoryFunction('telemetry', (container) => {
            const div = document.createElement('div');
            div.className = 'component-container';
            div.innerHTML = `
                <div class="hfo-header"><h3>Telemetry</h3></div>
                <div id="telemetry-display" style="padding: 0 16px; font-family: monospace; font-size: 11px;">
                    <p>FPS: <span id="tel-fps" style="color: var(--md-sys-color-primary)">0</span></p>
                    <p>HANDS: <span id="tel-hands" style="color: var(--hfo-red)">0</span></p>
                    <p>RES: <span id="tel-res">0x0</span></p>
                    <p>MEDALLION: <span style="color: #CD7F32">BRONZE</span></p>
                </div>
            `;
            container.getElement().appendChild(div);

            setInterval(() => {
                const fpsEl = document.getElementById('tel-fps');
                const handsEl = document.getElementById('tel-hands');
                const resEl = document.getElementById('tel-res');
                if (fpsEl) fpsEl.innerText = systemState.telemetry.fps;
                if (handsEl) handsEl.innerText = systemState.telemetry.handsDetected;
                if (resEl) resEl.innerText = systemState.telemetry.resolution;
            }, 100);
        });

        // --- Component: Logs ---
        layout.registerComponentFactoryFunction('logs', (container) => {
            const div = document.createElement('div');
            div.className = 'component-container';
            div.style.background = '#000';
            div.id = 'mission-logs-content';
            div.style.padding = '8px';
            div.style.fontSize = '10px';
            div.style.fontFamily = 'monospace';
            container.getElement().appendChild(div);
            logMission("PHOENIX_GEN4: READY");
        });

        layout.loadLayout(layoutConfig);
        window.addEventListener('resize', () => layout.updateSize());
    </script>
</body>

</html>